name: Build and push to ECR
on:
  push:
    branches: [main]
    permissions:
      contents: read
      id-token: write #FOR OIDC
    jobs:
      build-and-push:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3
          - name: Setup Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '15.14.0'
          - name: Install dependencies
            run: |
              cd codebase/rdicidr-0.1.0
              npm install
          - name: Lint
            run: npx eslint ./src/
            working-directory: ./codebase/rdicidr-0.1.0
          - name: Format check
            run: npx prettier -c ./src/ --check ..
            working-directory: ./codebase/rdicidr-0.1.0
          - name: Run tests
            run: npm test
            working-directory: ./codebase/rdicidr-0.1.0
          - name: Build application
            run: |
              cd codebase/rdicidr-0.1.0
              npm run build
          - name: Configure AWS credentials
            uses: aws-actions/configure-aws-credentials@v2
            with:
              role-to-assume: arn:aws:iam::183631345736:role/githubaction-fullstack-sre
              aws-region: us-east-1

          - name: Login to Amazon ECR
            uses: aws-actions/amazon-ecr-login@v2

          - name: Build, tag, and push image to Amazon ECR
            env:
              AWS_ACCOUNT_ID: 183631345736
              AWS_REGION: us-east-1
              ECR_REPOSITORY: fullstack-sre
              IMAGE_TAG: latest
            run: |
              # Build the Docker image
              docker build -t $ECR_REPOSITORY:$IMAGE_TAG -f codebase/rdicidr-0.1.0/Dockerfile codebase/rdicidr-0.1.0

              # Tag the image with the ECR registry
              docker tag $ECR_REPOSITORY:$IMAGE_TAG \
                $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

              # Push the image to ECR
              docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

    deploy-to-ec2:
      needs: build-and-push
      runs-on: ubuntu-latest
      steps:
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v2
          with:
          role-to-assume: arn:aws:iam::183631345736:role/githubaction-fullstack-sre
          aws-region: us-east-1
        - name: Deploy to EC2 instance via SSH
          uses: appleboy/ssh-action@v0.1.6
          env:
            SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          run: |
            echo "$SSH_KEY" > /tmp/key.pem
            chmod 600 /tmp/key.pem
            ECR_PASS=$(aws ecr get-login-password --region us-east-1)
          run: |
            ssh -o StrictHostKeyChecking=no -i /tmp/key.pem ${{secrets.EC2_USER}}@${{secrets.EC2_HOST}} << 'EOF'
              aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 183631345736.dkr.ecr.us-east-1.amazonaws.com
              docker pull 183631345736.dkr.ecr.us-east-1.amazonaws.com/fullstack-sre:latest
              docker stop rdicidr || true
              docker rm rdicidr || true
              docker run -d --name rdicidr -p 80:3000 183631345736.dkr.ecr.us-east-1.amazonaws.com/fullstack-sre:latest
            EOF