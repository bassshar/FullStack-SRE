name: Build and Push to ECR

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '15.14.0'

      - name: Install dependencies
        run: |
          cd codebase/rdicidr-0.1.0
          npm install

      - name: Lint
        run: npx eslint ./src/
        working-directory: codebase/rdicidr-0.1.0

      - name: Format check
        run: npx prettier -c ./src/ --check ..
        working-directory: codebase/rdicidr-0.1.0

      - name: Run tests
        run: |
          cd codebase/rdicidr-0.1.0
          CI=true npm test

      - name: Build application
        run: |
          cd codebase/rdicidr-0.1.0
          npm run build

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::183631345736:role/githubaction-fullstack-sre
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image
        env:
          AWS_ACCOUNT_ID: 183631345736
          AWS_REGION: us-east-1
          ECR_REPOSITORY: fullstack-sre
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG -f codebase/rdicidr-0.1.0/Dockerfile codebase/rdicidr-0.1.0
          docker tag $ECR_REPOSITORY:$IMAGE_TAG \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
          docker push \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::183631345736:role/githubaction-fullstack-sre
          aws-region: us-east-1

      - name: Deploy to EC2 via SSH
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "$SSH_KEY" > /tmp/key.pem
          chmod 600 /tmp/key.pem

          ECR_PASS=$(aws ecr get-login-password --region us-east-1)

          ssh -i /tmp/key.pem -o StrictHostKeyChecking=no \
            $EC2_USER@$EC2_HOST \
            "docker stop app || true && docker rm app || true && \
             echo '$ECR_PASS' | docker login --username AWS --password-stdin 183631345736.dkr.ecr.us-east-1.amazonaws.com && \
             docker pull 183631345736.dkr.ecr.us-east-1.amazonaws.com/fullstack-sre:latest && \
             docker run -d --name app -p 80:80 --restart unless-stopped \
             183631345736.dkr.ecr.us-east-1.amazonaws.com/fullstack-sre:latest"
